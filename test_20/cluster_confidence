    def perform_hdbscan_clustering(self, embeddings):
        if not HDBSCAN_AVAILABLE:
            print("HDBSCAN не доступен, используем K-means")
            return self.perform_kmeans_clustering(embeddings)

        print("Выполнение улучшенной HDBSCAN кластеризации...")

        min_clusters_desired = 3  # Желаемое минимальное количество кластеров
        best_labels = None
        best_confidence = None
        best_clusterer = None
        best_quality = -1

        # Параметры для попыток: (min_cluster_size, min_samples, cluster_selection_method)
        attempts_params = [
            self.optimize_hdbscan_parameters(embeddings),  # Первая попытка с обычными параметрами
            {
                'min_cluster_size': 3,
                'min_samples': 1,
                'cluster_selection_epsilon': 0.3,
                'metric': 'euclidean',
                'cluster_selection_method': 'leaf'
            },
            {
                'min_cluster_size': 2,
                'min_samples': 1,
                'cluster_selection_epsilon': 0.2,
                'metric': 'euclidean',
                'cluster_selection_method': 'leaf'
            }
        ]

        for i, params in enumerate(attempts_params):
            print(f"Попытка {i+1} с параметрами: {params}")
            clusterer = HDBSCAN(**params)
            labels = clusterer.fit_predict(embeddings)

            # Уверенность
            confidence_scores = clusterer.probabilities_
            confidence_scores[labels == -1] = 0.1

            # Оцениваем качество
            n_clusters = len(set(labels)) - (1 if -1 in labels else 0)
            quality = self.evaluate_clustering_quality(embeddings, labels)

            print(f"  Получено кластеров: {n_clusters}, качество: {quality:.3f}")

            # Если это первая попытка и кластеров достаточно, то берем ее
            if i == 0 and n_clusters >= min_clusters_desired:
                print(f"  Первая попытка дала {n_clusters} кластеров, приемлемо.")
                return labels, clusterer, confidence_scores

            # Иначе, если качество лучше и кластеров хотя бы 2, то запоминаем
            if n_clusters >= 2 and quality > best_quality:
                best_quality = quality
                best_labels = labels
                best_confidence = confidence_scores
                best_clusterer = clusterer

        # Если нашли какую-то кластеризацию с хотя бы 2 кластерами, возвращаем ее
        if best_labels is not None:
            n_clusters = len(set(best_labels)) - (1 if -1 in best_labels else 0)
            print(f"Выбрана кластеризация с {n_clusters} кластерами и качеством {best_quality:.3f}")
            return best_labels, best_clusterer, best_confidence

        # Если ничего не помогло, используем KMeans
        print("HDBSCAN не смог найти кластеры, используем K-means")
        return self.perform_kmeans_clustering(embeddings)
