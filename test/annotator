html

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Инструмент разметки NER</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Инструмент разметки NER</h1>
            <p>Загрузите CSV-файл для просмотра и редактирования разметки</p>
        </header>

        <div class="upload-section">
            <input type="file" id="csvFile" accept=".csv">
            <button id="loadBtn">Загрузить файл</button>
        </div>

        <div class="controls">
            <div class="navigation">
                <button id="prevBtn">← Предыдущая</button>
                <span id="currentIndex">0/0</span>
                <button id="nextBtn">Следующая →</button>
            </div>

            <div class="tag-buttons">
                <button class="tag-btn" data-tag="FIO">FIO</button>
                <button class="tag-btn" data-tag="LOC">LOC</button>
                <button class="tag-btn" data-tag="PHONE_NUM">PHONE_NUM</button>
                <button class="tag-btn" data-tag="LK_NUM">LK_NUM</button>
                <button class="tag-btn" data-tag="EMAIL">EMAIL</button>
                <button class="tag-btn" data-tag="ORG">ORG</button>
                <button class="tag-btn" data-tag="READINGS">READINGS</button>
                <button class="tag-btn" data-tag="DATE">DATE</button>
                <button class="tag-btn" data-tag="SUM">SUM</button>
                <button class="tag-btn" data-tag="O">O</button>
            </div>

            <div class="action-buttons">
                <button id="deleteBtn">Удалить строку</button>
                <button id="saveBtn">Сохранить изменения</button>
                <button id="exportBtn">Экспортировать CSV</button>
            </div>
        </div>

        <div class="data-display">
            <div class="row-info">
                <h3>Информация о строке</h3>
                <p><strong>ID диалога:</strong> <span id="dialogId"></span></p>
                <p><strong>Индекс сообщения:</strong> <span id="messageIndex"></span></p>
                <p><strong>Оригинальный текст:</strong> <span id="originalText"></span></p>
                <p><strong>Статус:</strong> <span id="successStatus"></span></p>
            </div>

            <div class="tokens-section">
                <h3>Токены и разметка</h3>
                <div id="tokensContainer" class="tokens-container"></div>
            </div>
        </div>

        <div class="status-message" id="statusMessage"></div>
    </div>

    <script src="script.js"></script>
</body>
</html>

css

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #f5f5f5;
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

header h1 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.upload-section {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
}

.upload-section input[type="file"] {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    flex-grow: 1;
}

.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
}

.navigation {
    display: flex;
    align-items: center;
    gap: 10px;
}

.tag-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    flex-grow: 1;
    justify-content: center;
}

.tag-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    background-color: #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
}

.tag-btn:hover {
    background-color: #dee2e6;
}

.action-buttons {
    display: flex;
    gap: 10px;
}

button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

#loadBtn, #saveBtn, #exportBtn {
    background-color: #007bff;
    color: white;
}

#loadBtn:hover, #saveBtn:hover, #exportBtn:hover {
    background-color: #0069d9;
}

#prevBtn, #nextBtn {
    background-color: #6c757d;
    color: white;
}

#prevBtn:hover, #nextBtn:hover {
    background-color: #5a6268;
}

#deleteBtn {
    background-color: #dc3545;
    color: white;
}

#deleteBtn:hover {
    background-color: #c82333;
}

.data-display {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    margin-bottom: 20px;
}

.row-info, .tokens-section {
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 5px;
}

.row-info h3, .tokens-section h3 {
    margin-bottom: 15px;
    color: #495057;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 8px;
}

.tokens-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 5px;
    min-height: 100px;
}

.token {
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}

.token:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.token.selected {
    box-shadow: 0 0 0 2px #007bff;
}

/* Цвета для различных типов меток */
.token-O { background-color: #f8f9fa; color: #6c757d; }
.token-B-FIO { background-color: #d4edda; color: #155724; }
.token-I-FIO { background-color: #c3e6cb; color: #155724; }
.token-B-LOC { background-color: #d1ecf1; color: #0c5460; }
.token-I-LOC { background-color: #bee5eb; color: #0c5460; }
.token-B-PHONE_NUM { background-color: #fff3cd; color: #856404; }
.token-I-PHONE_NUM { background-color: #ffeaa7; color: #856404; }
.token-B-LK_NUM { background-color: #f8d7da; color: #721c24; }
.token-I-LK_NUM { background-color: #f5c6cb; color: #721c24; }
.token-B-EMAIL { background-color: #e2e3e5; color: #383d41; }
.token-I-EMAIL { background-color: #d6d8db; color: #383d41; }
.token-B-ORG { background-color: #cce7ff; color: #004085; }
.token-I-ORG { background-color: #b3d7ff; color: #004085; }
.token-B-READINGS { background-color: #d6c8e6; color: #4a235a; }
.token-I-READINGS { background-color: #c9b4dd; color: #4a235a; }
.token-B-DATE { background-color: #f5cba7; color: #784212; }
.token-I-DATE { background-color: #f0b27a; color: #784212; }
.token-B-SUM { background-color: #a3e4d7; color: #0b5345; }
.token-I-SUM { background-color: #76d7c4; color: #0b5345; }

.status-message {
    padding: 10px 15px;
    border-radius: 4px;
    margin-top: 15px;
    display: none;
}

.status-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.status-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

@media (max-width: 768px) {
    .data-display {
        grid-template-columns: 1fr;
    }
    
    .controls {
        flex-direction: column;
    }
    
    .tag-buttons {
        order: 1;
    }
    
    .navigation {
        order: 2;
        justify-content: center;
    }
    
    .action-buttons {
        order: 3;
        justify-content: center;
    }
}

js

// Глобальные переменные
let csvData = [];
let currentRowIndex = 0;
let selectedTokens = [];

// Загрузка файла
document.getElementById('loadBtn').addEventListener('click', function() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showStatus('Пожалуйста, выберите файл', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parseCSV(e.target.result);
            showStatus('Файл успешно загружен', 'success');
            displayRow(currentRowIndex);
        } catch (error) {
            showStatus('Ошибка при загрузке файла: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
});

// Парсинг CSV
function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const headers = parseCSVLine(lines[0]);
    
    csvData = [];
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim() === '') continue;
        
        const values = parseCSVLine(lines[i]);
        if (values.length !== headers.length) continue;
        
        const row = {};
        for (let j = 0; j < headers.length; j++) {
            let value = values[j];
            
            // Парсинг массивов из строки
            if (value.startsWith('[') && value.endsWith(']')) {
                try {
                    value = JSON.parse(value.replace(/""/g, '"'));
                } catch (e) {
                    // Если не удалось распарсить, оставляем как строку
                }
            }
            
            // Преобразование строки 'True'/'False' в boolean
            if (value === 'True' || value === 'true') value = true;
            if (value === 'False' || value === 'false') value = false;
            
            row[headers[j]] = value;
        }
        
        csvData.push(row);
    }
    
    if (csvData.length === 0) {
        throw new Error('Файл не содержит данных или имеет неверный формат');
    }
}

// Парсинг строки CSV с учетом кавычек
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++; // Пропускаем следующую кавычку
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current);
    return result;
}

// Отображение текущей строки
function displayRow(index) {
    if (csvData.length === 0 || index < 0 || index >= csvData.length) {
        return;
    }
    
    const row = csvData[index];
    
    // Обновление информации о строке
    document.getElementById('dialogId').textContent = row.dialog_id || '';
    document.getElementById('messageIndex').textContent = row.dialog_message_index || '';
    document.getElementById('originalText').textContent = row.original_text || '';
    document.getElementById('successStatus').textContent = row.success ? 'Успешно' : 'Ошибка';
    
    // Обновление индекса
    document.getElementById('currentIndex').textContent = `${index + 1}/${csvData.length}`;
    
    // Отображение токенов
    displayTokens(row.tokens || [], row.ner_tags || []);
    
    // Сброс выбранных токенов
    selectedTokens = [];
}

// Отображение токенов с разметкой
function displayTokens(tokens, tags) {
    const container = document.getElementById('tokensContainer');
    container.innerHTML = '';
    
    if (tokens.length !== tags.length) {
        container.innerHTML = '<p>Ошибка: количество токенов и меток не совпадает</p>';
        return;
    }
    
    for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        const tag = tags[i];
        
        const tokenElement = document.createElement('div');
        tokenElement.className = `token token-${tag}`;
        tokenElement.textContent = token;
        tokenElement.dataset.index = i;
        
        tokenElement.addEventListener('click', function(e) {
            e.preventDefault();
            toggleTokenSelection(i);
        });
        
        container.appendChild(tokenElement);
    }
}

// Переключение выбора токена
function toggleTokenSelection(index) {
    const tokenIndex = selectedTokens.indexOf(index);
    
    if (tokenIndex === -1) {
        // Добавление токена к выбранным
        selectedTokens.push(index);
        document.querySelector(`.token[data-index="${index}"]`).classList.add('selected');
    } else {
        // Удаление токена из выбранных
        selectedTokens.splice(tokenIndex, 1);
        document.querySelector(`.token[data-index="${index}"]`).classList.remove('selected');
    }
}

// Назначение метки выбранным токенам
document.querySelectorAll('.tag-btn').forEach(button => {
    button.addEventListener('click', function() {
        if (csvData.length === 0) {
            showStatus('Сначала загрузите файл', 'error');
            return;
        }
        
        if (selectedTokens.length === 0) {
            showStatus('Выберите хотя бы один токен', 'error');
            return;
        }
        
        const tag = this.dataset.tag;
        const row = csvData[currentRowIndex];
        
        // Для метки O назначаем всем токенам O
        if (tag === 'O') {
            selectedTokens.forEach(index => {
                row.ner_tags[index] = 'O';
            });
        } else {
            // Для других меток: первый токен получает B-, остальные I-
            selectedTokens.forEach((index, i) => {
                const prefix = i === 0 ? 'B-' : 'I-';
                row.ner_tags[index] = prefix + tag;
            });
        }
        
        // Обновляем отображение
        displayTokens(row.tokens, row.ner_tags);
        selectedTokens = [];
        
        showStatus('Метка применена', 'success');
    });
});

// Навигация
document.getElementById('prevBtn').addEventListener('click', function() {
    if (currentRowIndex > 0) {
        currentRowIndex--;
        displayRow(currentRowIndex);
    }
});

document.getElementById('nextBtn').addEventListener('click', function() {
    if (currentRowIndex < csvData.length - 1) {
        currentRowIndex++;
        displayRow(currentRowIndex);
    }
});

// Удаление строки
document.getElementById('deleteBtn').addEventListener('click', function() {
    if (csvData.length === 0) return;
    
    if (confirm('Вы уверены, что хотите удалить эту строку?')) {
        csvData.splice(currentRowIndex, 1);
        
        if (csvData.length === 0) {
            // Если удалили все строки
            document.getElementById('tokensContainer').innerHTML = '';
            document.getElementById('currentIndex').textContent = '0/0';
            showStatus('Все строки удалены', 'success');
            return;
        }
        
        // Корректируем индекс, если удалили последнюю строку
        if (currentRowIndex >= csvData.length) {
            currentRowIndex = csvData.length - 1;
        }
        
        displayRow(currentRowIndex);
        showStatus('Строка удалена', 'success');
    }
});

// Сохранение изменений
document.getElementById('saveBtn').addEventListener('click', function() {
    if (csvData.length === 0) {
        showStatus('Нет данных для сохранения', 'error');
        return;
    }
    
    showStatus('Изменения сохранены', 'success');
});

// Экспорт CSV
document.getElementById('exportBtn').addEventListener('click', function() {
    if (csvData.length === 0) {
        showStatus('Нет данных для экспорта', 'error');
        return;
    }
    
    // Получаем заголовки из первой строки
    const headers = Object.keys(csvData[0]);
    
    // Создаем CSV содержимое
    let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
    
    csvData.forEach(row => {
        const values = headers.map(header => {
            let value = row[header];
            
            // Если значение - массив, преобразуем в строку JSON
            if (Array.isArray(value)) {
                value = JSON.stringify(value).replace(/"/g, '""');
                return `"${value}"`;
            }
            
            // Если значение - булево, преобразуем в строку
            if (typeof value === 'boolean') {
                return value ? 'True' : 'False';
            }
            
            // Экранируем кавычки и оборачиваем в кавычки, если содержит запятые
            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                value = value.replace(/"/g, '""');
                return `"${value}"`;
            }
            
            return value;
        });
        
        csvContent += values.join(',') + '\n';
    });
    
    // Создаем и скачиваем файл
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'ner_data_updated.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showStatus('Файл экспортирован', 'success');
});

// Показать статусное сообщение
function showStatus(message, type) {
    const statusElement = document.getElementById('statusMessage');
    statusElement.textContent = message;
    statusElement.className = `status-message ${type}`;
    
    // Автоматически скрыть через 3 секунды
    setTimeout(() => {
        statusElement.style.display = 'none';
    }, 3000);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    showStatus('Загрузите CSV файл для начала работы', 'success');
});
