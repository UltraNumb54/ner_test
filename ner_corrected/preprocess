# preprocess_punctuation.py
import json
import re

def separate_punctuation(text):
    """
    Разделяет пунктуацию и специальные символы в тексте пробелами
    """
    if not text or not isinstance(text, str):
        return text
    
    # Паттерны для разделения
    patterns = [
        (r'([!?.,:;()"\-—–/\\])', r' \1 '),  # Основная пунктуация и дефисы
        (r'(\d)([.,])(\d)', r'\1 \2 \3'),    # Числа с разделителями
        (r'([a-zA-Zа-яА-Я])(\-)([a-zA-Zа-яА-Я])', r'\1 \2 \3'),  # Дефисы между буквами
        (r'\s+', ' '),  # Убираем лишние пробелы
    ]
    
    # Применяем все паттерны последовательно
    processed_text = text
    for pattern, replacement in patterns:
        processed_text = re.sub(pattern, replacement, processed_text)
    
    # Финальная очистка пробелов
    processed_text = re.sub(r'\s+', ' ', processed_text).strip()
    
    return processed_text

def process_json_file(input_file, output_file):
    """
    Обрабатывает JSON файл, разделяя пунктуацию в текстах
    """
    print(f"Чтение файла: {input_file}")
    
    with open(input_file, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    print(f"Обработка {len(data)} диалогов...")
    
    processed_data = []
    
    for dialog in data:
        processed_dialog = dialog.copy()
        
        if 'dialogue' in dialog:
            processed_dialogue = []
            
            for message in dialog['dialogue']:
                processed_message = message.copy()
                
                if 'text' in message and message['text']:
                    # Разделяем текст на строки и обрабатываем каждую
                    lines = message['text'].split('\n')
                    processed_lines = []
                    
                    for line in lines:
                        if line.strip():
                            processed_line = separate_punctuation(line)
                            processed_lines.append(processed_line)
                        else:
                            processed_lines.append(line)
                    
                    processed_message['text'] = '\n'.join(processed_lines)
                
                processed_dialogue.append(processed_message)
            
            processed_dialog['dialogue'] = processed_dialogue
        
        processed_data.append(processed_dialog)
    
    # Сохраняем результат
    print(f"Сохранение в: {output_file}")
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(processed_data, f, ensure_ascii=False, indent=2)
    
    # Показываем примеры преобразования
    print("\nПримеры преобразования:")
    for i, dialog in enumerate(data[:2]):  # Первые 2 диалога
        if 'dialogue' in dialog:
            for j, message in enumerate(dialog['dialogue'][:2]):  # Первые 2 сообщения
                if 'text' in message:
                    original = message['text']
                    processed = processed_data[i]['dialogue'][j]['text']
                    print(f"Оригинал: '{original}'")
                    print(f"Обработано: '{processed}'")
                    print()
    
    return processed_data

def test_separate_punctuation():
    """
    Тестирование функции разделения пунктуации
    """
    test_cases = [
        "Добрый день!",
        "НМ-120303.12",
        "НМ-120303,12",
        "Привет, как дела?",
        "Стоимость: 1000.50 руб.",
        "Телефон: +7(123)456-78-90",
        "Адрес: ул.Ленина, д.25, кв.12",
        "Время: 12:30-13:45",
    ]
    
    print("Тестирование функции разделения пунктуации:")
    for test in test_cases:
        result = separate_punctuation(test)
        print(f"'{test}' -> '{result}'")

def main():
    """
    Основная функция
    """
    # ==================== КОНФИГУРАЦИЯ ====================
    INPUT_JSON = "input_data.json"          # Исходный JSON файл
    OUTPUT_JSON = "processed_data.json"     # Обработанный JSON файл
    RUN_TESTS = True                        # Запустить тесты
    # ======================================================
    
    if RUN_TESTS:
        test_separate_punctuation()
        print("\n" + "="*50 + "\n")
    
    try:
        process_json_file(INPUT_JSON, OUTPUT_JSON)
        print("Обработка завершена успешно!")
    except FileNotFoundError:
        print(f"Ошибка: файл {INPUT_JSON} не найден!")
    except Exception as e:
        print(f"Ошибка при обработке: {e}")

if __name__ == "__main__":
    main()
