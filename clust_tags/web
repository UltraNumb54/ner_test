<!DOCTYPE html>
<html>
<head>
    <title>Cluster Editor</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .dialog { border: 1px solid #ccc; padding: 10px; margin: 10px 0; position: relative; }
        .user { color: #0066cc; }
        .assistant { color: #00aa00; }
        .tag { background: #eee; padding: 2px 6px; margin: 2px; border-radius: 3px; display: inline-block; }
        button { margin: 5px; cursor: pointer; }
        .pagination { margin: 20px 0; }
        .delete-btn { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            background: #ff4444; 
            color: white; 
            border: none; 
            padding: 5px 10px;
            cursor: pointer;
        }
        .stats { margin: 10px 0; color: #666; }
    </style>
</head>
<body>
    <h1>Cluster Editor</h1>
    
    <div>
        <input type="file" id="fileInput" accept=".json">
        <button onclick="exportData()">Export JSON</button>
        <span class="stats" id="stats">Total dialogs: 0</span>
    </div>

    <div>
        <h3>Available Tags:</h3>
        <div id="tagsContainer"></div>
        <input type="text" id="newTagInput" placeholder="New tag">
        <button onclick="addNewTag()">Add Tag</button>
    </div>

    <hr>
    
    <div class="pagination">
        <button onclick="changePage(-1)">Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button onclick="changePage(1)">Next</button>
        <select id="pageSize" onchange="changePageSize()">
            <option value="10">10 per page</option>
            <option value="20">20 per page</option>
            <option value="50" selected>50 per page</option>
            <option value="100">100 per page</option>
        </select>
    </div>
    
    <div id="dialogsContainer"></div>

    <div class="pagination">
        <button onclick="changePage(-1)">Previous</button>
        <span id="pageInfoBottom">Page 1 of 1</span>
        <button onclick="changePage(1)">Next</button>
    </div>

    <script src="script.js"></script>
</body>
</html>


let originalData = [];
let clusters = new Map();
let nextClusterId = 1;

// Пагинация
let currentPage = 1;
let itemsPerPage = 50;

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        originalData = JSON.parse(e.target.result);
        processData(originalData);
        currentPage = 1;
        renderDialogs();
        updateTagsDisplay();
        updateStats();
    };
    
    reader.readAsText(file);
});

function processData(data) {
    clusters.clear();
    nextClusterId = 1;
    
    data.forEach(item => {
        if (item.cluster && !clusters.has(item.cluster)) {
            clusters.set(item.cluster, nextClusterId++);
        }
    });
}

function updateStats() {
    const statsElem = document.getElementById('stats');
    statsElem.textContent = `Total dialogs: ${originalData.length}`;
}

function updateTagsDisplay() {
    const container = document.getElementById('tagsContainer');
    container.innerHTML = '';
    
    clusters.forEach((id, name) => {
        const tagElem = document.createElement('span');
        tagElem.className = 'tag';
        tagElem.innerHTML = `
            ${name} (ID: ${id})
            <button onclick="editTag('${name}')">✏️</button>
            <button onclick="deleteTag('${name}')">❌</button>
        `;
        container.appendChild(tagElem);
    });
}

function renderDialogs() {
    const container = document.getElementById('dialogsContainer');
    container.innerHTML = '';

    // Вычисляем диапазон отображаемых записей
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, originalData.length);
    const currentDialogs = originalData.slice(startIndex, endIndex);

    currentDialogs.forEach((dialog, localIndex) => {
        const globalIndex = startIndex + localIndex;
        const dialogElem = document.createElement('div');
        dialogElem.className = 'dialog';
        dialogElem.innerHTML = `
            <button class="delete-btn" onclick="deleteDialog(${globalIndex})">Delete</button>
            <h3>Dialog ID: ${dialog.dialog_id}</h3>
            <select onchange="updateCluster(${globalIndex}, this.value)">
                <option value="">Select Cluster</option>
                ${Array.from(clusters.entries()).map(([name, id]) => `
                    <option value="${name}" ${dialog.cluster === name ? 'selected' : ''}>
                        ${name} (ID: ${id})
                    </option>
                `).join('')}
            </select>
            <div class="messages">
                ${dialog.full_dialog.messages.map(msg => `
                    <div class="${msg.role}">
                        <strong>${msg.role}:</strong> ${msg.message}
                    </div>
                `).join('')}
            </div>
        `;
        container.appendChild(dialogElem);
    });

    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(originalData.length / itemsPerPage);
    const pageInfo = `Page ${currentPage} of ${totalPages} (${originalData.length} total dialogs)`;
    document.getElementById('pageInfo').textContent = pageInfo;
    document.getElementById('pageInfoBottom').textContent = pageInfo;
}

function changePage(direction) {
    const totalPages = Math.ceil(originalData.length / itemsPerPage);
    const newPage = currentPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderDialogs();
    }
}

function changePageSize() {
    itemsPerPage = parseInt(document.getElementById('pageSize').value);
    currentPage = 1;
    renderDialogs();
}

function addNewTag() {
    const input = document.getElementById('newTagInput');
    const newTag = input.value.trim();
    
    if (newTag && !clusters.has(newTag)) {
        clusters.set(newTag, nextClusterId++);
        updateTagsDisplay();
        renderDialogs();
        input.value = '';
    }
}

function editTag(oldName) {
    const newName = prompt('Enter new tag name:', oldName);
    if (newName && newName !== oldName) {
        const id = clusters.get(oldName);
        clusters.delete(oldName);
        clusters.set(newName, id);
        
        originalData.forEach(dialog => {
            if (dialog.cluster === oldName) dialog.cluster = newName;
        });
        
        updateTagsDisplay();
        renderDialogs();
    }
}

function deleteTag(name) {
    if (confirm(`Delete tag "${name}"?`)) {
        clusters.delete(name);
        originalData.forEach(dialog => {
            if (dialog.cluster === name) dialog.cluster = '';
        });
        updateTagsDisplay();
        renderDialogs();
    }
}

function deleteDialog(index) {
    if (confirm('Delete this dialog?')) {
        originalData.splice(index, 1);
        updateStats();
        renderDialogs();
    }
}

function updateCluster(dialogIndex, clusterName) {
    originalData[dialogIndex].cluster = clusterName;
}

function exportData() {
    const exportData = originalData.map(dialog => ({
        ...dialog,
        cluster_id: clusters.get(dialog.cluster) || 0
    }));

    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'updated_data.json';
    link.click();
    
    URL.revokeObjectURL(url);
}
